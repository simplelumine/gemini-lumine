name: "ðŸ§™ Gemini Issue Fixer"

on:
  workflow_call:

concurrency:
  group: "${{ github.workflow }}-${{ github.head_ref || github.ref }}-${{ github.event.issue.number }}"
  cancel-in-progress: true

defaults:
  run:
    shell: "bash"

jobs:
  create-pr:
    timeout-minutes: 30
    runs-on: "ubuntu-latest"
    permissions:
      contents: "write"
      id-token: "write"
      issues: "write"
      pull-requests: "write"

    steps:
      - name: "Mint identity token"
        id: "mint_identity_token"
        if: |-
          ${{ vars.APP_ID }}
        uses: "actions/create-github-app-token@a8d616148505b5069dccd32f177bb87d7f39123b" # ratchet:actions/create-github-app-token@v2
        with:
          app-id: "${{ vars.APP_ID }}"
          private-key: "${{ secrets.APP_PRIVATE_KEY }}"
          permission-contents: "write"
          permission-issues: "write"
          permission-pull-requests: "write"

      - name: "Checkout repository"
        uses: "actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8" # ratchet:actions/checkout@v5

      - name: "Run Gemini PR Create"
        uses: "google-github-actions/run-gemini-cli@v0"
        id: "gemini_pr_create"
        env:
          GITHUB_TOKEN: "${{ steps.mint_identity_token.outputs.token || secrets.GITHUB_TOKEN }}"
          REPOSITORY: "${{ github.repository }}"
          ISSUE_NUMBER: "${{ github.event.issue.number }}"
          ISSUE_TITLE: "${{ github.event.issue.title }}"
          ISSUE_BODY: "${{ github.event.issue.body }}"
          BRANCH_NAME: "gemini-fix-${{ github.event.issue.number }}"
          EVENT_NAME: "${{ github.event_name }}"
          TRIGGERING_ACTOR: "${{ github.triggering_actor }}"
        with:
          gcp_location: "${{ vars.GOOGLE_CLOUD_LOCATION }}"
          gcp_project_id: "${{ vars.GOOGLE_CLOUD_PROJECT }}"
          gcp_service_account: "${{ vars.SERVICE_ACCOUNT_EMAIL }}"
          gcp_workload_identity_provider: "${{ vars.GCP_WIF_PROVIDER }}"
          gemini_api_key: "${{ secrets.GEMINI_API_KEY }}"
          gemini_cli_version: "${{ vars.GEMINI_CLI_VERSION }}"
          gemini_debug: "${{ fromJSON(vars.GEMINI_DEBUG || vars.ACTIONS_STEP_DEBUG || false) }}"
          gemini_model: "${{ vars.GEMINI_MODEL }}"
          google_api_key: "${{ secrets.GOOGLE_API_KEY }}"
          use_gemini_code_assist: "${{ vars.GOOGLE_GENAI_USE_GCA }}"
          use_vertex_ai: "${{ vars.GOOGLE_GENAI_USE_VERTEXAI }}"
          upload_artifacts: "${{ vars.UPLOAD_ARTIFACTS }}"
          settings: |-
            {
              "debug": ${{ fromJSON(vars.GEMINI_DEBUG || vars.ACTIONS_STEP_DEBUG || false) }},
              "model": {
                "maxSessionTurns": 200
              },
              "mcpServers": {
                "github": {
                  "command": "docker",
                  "args": [
                    "run",
                    "-i",
                    "--rm",
                    "-e",
                    "GITHUB_PERSONAL_ACCESS_TOKEN",
                    "ghcr.io/github/github-mcp-server:v0.18.0"
                  ],
                  "env": {
                    "GITHUB_PERSONAL_ACCESS_TOKEN": "${GITHUB_TOKEN}"
                  }
                }
              },
              "telemetry": {
                "enabled": true,
                "target": "local",
                "outfile": ".gemini/telemetry.log"
              }
            }
          prompt: |-
            ## Role

            You are an expert software engineer. Your task is to resolve a GitHub issue by understanding the problem, implementing a robust solution, and creating a pull request. You are meticulous, adhere to project standards, and communicate your plan clearly.

            ## Context

            This information is from the GitHub event that triggered your execution. Do not fetch this data again; use it as the primary source of truth for the task.

            - **Event Type**: ${{ env.EVENT_NAME }}
            - **Triggering User**: ${{ env.TRIGGERING_ACTOR }}
            - **Repository**: ${{ env.REPOSITORY }}
            - **Issue Number**: ${{ env.ISSUE_NUMBER }}
            - **Issue Title**: ${{ env.ISSUE_TITLE }}
            - **Issue Body**: ${{ env.ISSUE_BODY }}
            - **Branch Name**: ${{ env.BRANCH_NAME }}

            ## Instructions

            Follow these steps sequentially to resolve the issue:

            ### Step 1: Understand Project Standards
            The initial context provided to you includes a file tree. If you see a `GEMINI.md` or `CONTRIBUTING.md` file, use the GitHub MCP `get_file_contents` tool to read it first.

            ### Step 2: Acknowledge and Plan
            1. Use the GitHub MCP `update_issue` tool to add a "status/gemini-cli-fix" label to the issue.
            2. Use the `gh issue comment` CLI tool command to post an initial comment. In this comment, you must:
                - State the problem in your own words.
                - Briefly describe the current state of the relevant code.
                - Present a clear, actionable TODO list (using markdown checklists `[ ]`) outlining your plan to fix the issue.

            ### Step 3: Create Branch locally
            Use the `git` CLI tool to checkout a new branch for your work. Name it `${{ env.BRANCH_NAME }}`. The command should be: `git checkout -b ${{ env.BRANCH_NAME }}`.

            ### Step 4: Create Branch remotely
            Use the GitHub MCP `create_branch` tool to create a new branch for your work. Name it `${{ env.BRANCH_NAME }}`.

            ### Step 5: Investigate and Implement
            Use tools, like the GitHub MCP `search_code` and GitHub MCP `get_file_contents` tools, to explore the codebase and implement the necessary code changes. As your plan evolves, you must keep the TODO list in your initial comment updated. Use the `gh issue comment --edit-last --body "..."` command for this.

            ### Step 6: Verify Solution
            Follow the project-specific instructions from `GEMINI.md` or `CONTRIBUTING.md` to run builds, linters, and tests. Ensure your changes have not introduced any regressions.

            ### Step 7: Commit the changes
            Commit the changes to the branch `${{ env.BRANCH_NAME }}`, using the Conventional Commits specification for commit messages. Use the `git` CLI tool.

            ### Step 8: Create Pull Request
            Once the solution is fully implemented and verified, use the GitHub MCP `create_pull_request` tool to open a PR. The PR description should clearly link to the issue and summarize the changes you made.

            ### Step 9: Amend your Plan
            Use the `gh issue comment --edit-last` CLI tool command to edit your initial comment. Update the markdown checklist to check the boxes of what is complete with `[x]`, and suffix a link to your pull request by mentioning `#<PULL_REQUEST_NUMBER>`.

            ## Guidelines

            - Be Respectful: Your communication should always be constructive and professional.
            - Be Actionable: Your feedback and code should be specific and clear.
            - Follow Conventions: Adhere strictly to the existing coding style and patterns in the repository.
            - Use Tools: Rely on the provided tools for all interactions with the repository. Do not guess file contents or state.
            - Handle Shell Variables Safely: When defining or using variables in shell commands, ensure they are properly quoted to prevent errors.
            - If something prevents you from fixing the issue, such as a permissions issue, inform the user in your comment on the issue why you cannot complete the task.
            - **Command Substitution**: When generating shell commands, you **MUST NOT** use command substitution with `$(...)`, `<(...)`, or `>(...)`. This is a security measure to prevent unintended command execution.
